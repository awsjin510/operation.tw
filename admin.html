<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¾Œå°ç®¡ç† | operation.tw</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --cyan:#00f5ff;--pink:#ff0080;--purple:#bf00ff;--yellow:#ffff00;--green:#00ff88;
  --bg:#050510;--bg2:#0a0a1a;--bg3:#0d0d22;--bg4:#111128;
  --border:rgba(0,245,255,.1);--border2:rgba(0,245,255,.3);
  --text:#e0e0ff;--dim:#6060a0;--mid:#9090cc;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans TC',sans-serif;line-height:1.7;min-height:100vh;display:flex;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,245,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.02) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}

/* SIDEBAR */
.sidebar{width:220px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);min-height:100vh;position:sticky;top:0;height:100vh;overflow-y:auto;display:flex;flex-direction:column;z-index:10;}
.sb-logo{padding:22px 18px 16px;border-bottom:1px solid var(--border);}
.sb-logo-text{font-family:'Orbitron',monospace;font-weight:900;font-size:.78rem;letter-spacing:.15em;color:var(--cyan);text-shadow:0 0 8px var(--cyan);}
.sb-logo-sub{font-family:'Share Tech Mono',monospace;font-size:.58rem;color:var(--dim);margin-top:3px;letter-spacing:.1em;}
.sb-nav{padding:12px 0;flex:1;}
.sb-section{font-family:'Share Tech Mono',monospace;font-size:.55rem;color:var(--dim);letter-spacing:.2em;text-transform:uppercase;padding:12px 18px 6px;}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 18px;cursor:pointer;font-family:'Share Tech Mono',monospace;font-size:.72rem;color:var(--mid);letter-spacing:.06em;transition:all .2s;border:none;background:none;width:100%;text-align:left;}
.sb-item:hover{background:rgba(0,245,255,.05);color:var(--text);}
.sb-item.active{background:rgba(0,245,255,.08);color:var(--cyan);border-right:2px solid var(--cyan);}
.sb-item .si{font-size:1rem;width:18px;text-align:center;}
.sb-bottom{padding:14px 18px;border-top:1px solid var(--border);}
.sb-preview-btn{display:block;width:100%;padding:9px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--cyan);border:1px solid var(--cyan);background:transparent;cursor:pointer;letter-spacing:.08em;text-transform:uppercase;transition:all .25s;text-decoration:none;}
.sb-preview-btn:hover{background:var(--cyan);color:var(--bg);}

/* MAIN */
.main{flex:1;padding:32px 36px;max-width:100%;overflow-x:hidden;position:relative;z-index:1;}
.panel{display:none;}
.panel.active{display:block;}
.panel-title{font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:700;color:#fff;margin-bottom:6px;}
.panel-sub{font-family:'Share Tech Mono',monospace;font-size:.62rem;color:var(--dim);letter-spacing:.1em;margin-bottom:28px;}
.divider{height:1px;background:linear-gradient(to right,var(--border2),transparent);margin:28px 0;}

/* CARDS */
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:28px;}
.stat-card{background:var(--bg2);border:1px solid var(--border);padding:18px;position:relative;overflow:hidden;}
.stat-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(to right,transparent,var(--cyan),transparent);opacity:.3;}
.stat-card .sn{font-family:'Orbitron',monospace;font-size:1.8rem;font-weight:900;color:var(--cyan);}
.stat-card .sl{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);margin-top:4px;letter-spacing:.08em;text-transform:uppercase;}

/* FORM */
.form-group{margin-bottom:20px;}
.form-label{font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--mid);letter-spacing:.1em;text-transform:uppercase;margin-bottom:7px;display:flex;align-items:center;gap:8px;}
.form-label .tip{font-size:.58rem;color:var(--dim);text-transform:none;letter-spacing:0;}
input[type=text],input[type=date],input[type=url],textarea,select{width:100%;background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--text);font-family:'Noto Sans TC',sans-serif;font-size:.88rem;padding:10px 14px;outline:none;transition:border-color .2s;}
input[type=text]:focus,input[type=date]:focus,input[type=url]:focus,textarea:focus,select:focus{border-color:var(--cyan);}
select{cursor:pointer;}
select option{background:var(--bg3);color:var(--text);}
textarea{resize:vertical;min-height:90px;line-height:1.7;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}

/* RICH EDITOR */
.editor-toolbar{background:var(--bg3);border:1px solid var(--border);border-bottom:none;padding:8px 12px;display:flex;flex-wrap:wrap;gap:4px;align-items:center;}
.tb-btn{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--mid);cursor:pointer;padding:4px 9px;font-size:.75rem;font-family:'Share Tech Mono',monospace;transition:all .18s;line-height:1.4;}
.tb-btn:hover{border-color:var(--cyan);color:var(--cyan);}
.tb-btn.active{background:rgba(0,245,255,.12);border-color:var(--cyan);color:var(--cyan);}
.tb-sep{width:1px;height:20px;background:var(--border);margin:0 4px;flex-shrink:0;}
.tb-select{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--mid);font-family:'Share Tech Mono',monospace;font-size:.65rem;padding:4px 6px;cursor:pointer;outline:none;}
.tb-select option{background:var(--bg3);}
.editor-area{border:1px solid var(--border);min-height:320px;padding:18px;outline:none;font-size:.95rem;line-height:1.9;color:var(--text);background:rgba(255,255,255,.02);}
.editor-area:focus{border-color:var(--cyan);}
.editor-area h2{font-family:'Orbitron',monospace;color:var(--cyan);font-size:1.15rem;margin:1.5em 0 .6em;padding-bottom:8px;border-bottom:1px solid var(--border);}
.editor-area h3{font-family:'Orbitron',monospace;color:var(--pink);font-size:.95rem;margin:1.2em 0 .5em;}
.editor-area a{color:var(--cyan);text-underline-offset:3px;}
.editor-area img{max-width:100%;border:1px solid var(--border);margin:12px 0;display:block;}
.editor-area blockquote{border-left:3px solid var(--pink);background:rgba(255,0,128,.04);padding:12px 16px;margin:1em 0;color:var(--mid);}
.editor-area pre{background:var(--bg3);border-left:3px solid var(--cyan);padding:14px;font-family:'Share Tech Mono',monospace;font-size:.82rem;color:var(--green);margin:1em 0;overflow-x:auto;}
.editor-area ul,.editor-area ol{padding-left:1.5em;margin:.8em 0;}
.editor-area p{margin:.5em 0;}
.editor-hint{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);margin-top:7px;letter-spacing:.05em;}

/* IMAGE UPLOAD */
.img-drop{border:2px dashed var(--border);padding:24px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.img-drop:hover,.img-drop.drag{border-color:var(--cyan);background:rgba(0,245,255,.03);}
.img-drop input{position:absolute;inset:0;opacity:0;cursor:pointer;}
.img-drop-txt{font-family:'Share Tech Mono',monospace;font-size:.72rem;color:var(--dim);}
.img-drop-txt span{color:var(--cyan);}
.img-preview-wrap{margin-top:12px;display:none;}
.img-preview{max-height:140px;border:1px solid var(--border);display:block;}
.img-url-or{display:flex;align-items:center;gap:10px;margin:10px 0;font-family:'Share Tech Mono',monospace;font-size:.62rem;color:var(--dim);}
.img-url-or::before,.img-url-or::after{content:'';flex:1;height:1px;background:var(--border);}

/* POST LIST */
.post-list{display:flex;flex-direction:column;gap:0;}
.post-row{display:flex;align-items:center;gap:14px;padding:13px 16px;border-bottom:1px solid var(--border);transition:background .18s;}
.post-row:hover{background:rgba(255,255,255,.02);}
.pr-cat{font-family:'Share Tech Mono',monospace;font-size:.6rem;padding:2px 8px;border:1px solid;letter-spacing:.08em;flex-shrink:0;}
.pr-title{flex:1;font-size:.88rem;color:var(--text);font-weight:500;}
.pr-date{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);flex-shrink:0;}
.pr-status{font-family:'Share Tech Mono',monospace;font-size:.58rem;padding:2px 8px;flex-shrink:0;}
.pr-status.pub{background:rgba(0,255,136,.1);border:1px solid rgba(0,255,136,.3);color:var(--green);}
.pr-status.dft{background:rgba(255,255,0,.08);border:1px solid rgba(255,255,0,.2);color:var(--yellow);}
.pr-actions{display:flex;gap:6px;flex-shrink:0;}
.pr-btn{font-family:'Share Tech Mono',monospace;font-size:.6rem;padding:4px 10px;border:1px solid var(--border);color:var(--dim);cursor:pointer;background:transparent;transition:all .18s;letter-spacing:.05em;}
.pr-btn:hover{border-color:var(--cyan);color:var(--cyan);}
.pr-btn.del:hover{border-color:var(--pink);color:var(--pink);}

/* BUTTONS */
.btn-row{display:flex;gap:10px;margin-top:24px;flex-wrap:wrap;}
.btn{font-family:'Share Tech Mono',monospace;font-size:.72rem;padding:10px 22px;border:1px solid;cursor:pointer;letter-spacing:.1em;text-transform:uppercase;transition:all .25s;}
.btn-primary{border-color:var(--cyan);color:var(--cyan);background:rgba(0,245,255,.08);}
.btn-primary:hover{background:var(--cyan);color:var(--bg);}
.btn-danger{border-color:var(--pink);color:var(--pink);background:transparent;}
.btn-danger:hover{background:var(--pink);color:var(--bg);}
.btn-ghost{border-color:var(--border);color:var(--dim);background:transparent;}
.btn-ghost:hover{border-color:var(--mid);color:var(--mid);}

/* TOAST */
.toast{position:fixed;bottom:28px;right:28px;background:var(--bg3);border:1px solid var(--green);color:var(--green);font-family:'Share Tech Mono',monospace;font-size:.72rem;padding:12px 20px;letter-spacing:.08em;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;}
.toast.show{opacity:1;}
.toast.error{border-color:var(--pink);color:var(--pink);}

/* MODAL */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center;}
.modal-bg.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border);padding:32px;max-width:440px;width:90%;}
.modal h3{font-family:'Orbitron',monospace;font-size:.95rem;color:#fff;margin-bottom:12px;}
.modal p{color:var(--mid);font-size:.88rem;margin-bottom:24px;line-height:1.7;}
.modal-btns{display:flex;gap:10px;}

/* LINK MODAL */
.lm{max-width:400px;}
.lm input{margin-bottom:12px;}

/* TABS (html/visual) */
.editor-tabs{display:flex;gap:0;margin-bottom:0;}
.etab{font-family:'Share Tech Mono',monospace;font-size:.65rem;padding:7px 16px;border:1px solid var(--border);border-bottom:none;color:var(--dim);cursor:pointer;background:transparent;letter-spacing:.08em;transition:all .2s;}
.etab.on{background:rgba(255,255,255,.04);color:var(--cyan);border-color:var(--cyan);}
.html-area{border:1px solid var(--border);min-height:320px;padding:16px;font-family:'Share Tech Mono',monospace;font-size:.8rem;color:var(--green);background:rgba(0,255,136,.02);resize:vertical;display:none;width:100%;outline:none;}
.html-area:focus{border-color:var(--cyan);}

/* QUICK ACTIONS */
.qa-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;}
.qa{background:var(--bg2);border:1px solid var(--border);padding:16px;cursor:pointer;text-align:center;transition:all .22s;}
.qa:hover{border-color:var(--border2);transform:translateY(-2px);}
.qa-icon{font-size:1.4rem;margin-bottom:6px;}
.qa-label{font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--mid);letter-spacing:.06em;}

@media(max-width:768px){
  .sidebar{display:none;}
  .main{padding:20px 16px;}
  .stat-row{grid-template-columns:1fr 1fr;}
  .form-row,.form-row3{grid-template-columns:1fr;}
  .qa-grid{grid-template-columns:1fr 1fr;}
}
::selection{background:rgba(0,245,255,.2);color:#fff;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:rgba(0,245,255,.2);}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-text">æ“ä½œä¸€ä¸‹</div>
    <div class="sb-logo-sub">// ADMIN PANEL</div>
  </div>
  <nav class="sb-nav">
    <div class="sb-section">å…§å®¹</div>
    <button class="sb-item active" onclick="nav('dashboard')" id="nav-dashboard"><span class="si">ğŸ“Š</span>å„€è¡¨æ¿</button>
    <button class="sb-item" onclick="nav('posts')" id="nav-posts"><span class="si">ğŸ“</span>æ–‡ç« ç®¡ç†</button>
    <button class="sb-item" onclick="nav('editor')" id="nav-editor"><span class="si">âœï¸</span>æ–°å¢æ–‡ç« </button>
    <div class="sb-section">é é¢</div>
    <button class="sb-item" onclick="nav('homepage')" id="nav-homepage"><span class="si">ğŸ </span>é¦–é è¨­å®š</button>
    <button class="sb-item" onclick="nav('about')" id="nav-about"><span class="si">ğŸ‘¤</span>é—œæ–¼æˆ‘</button>
    <div class="sb-section">ç³»çµ±</div>
    <button class="sb-item" onclick="nav('data')" id="nav-data"><span class="si">ğŸ’¾</span>è³‡æ–™ç®¡ç†</button>
  </nav>
  <div class="sb-bottom">
    <a class="sb-preview-btn" href="index.html" target="_blank">â†— é è¦½ç¶²ç«™</a>
  </div>
</aside>

<!-- MAIN -->
<main class="main">

<!-- DASHBOARD -->
<div class="panel active" id="p-dashboard">
  <div class="panel-title">å„€è¡¨æ¿</div>
  <div class="panel-sub">// DASHBOARD â€” æ­¡è¿å›ä¾†</div>
  <div class="stat-row">
    <div class="stat-card"><div class="sn" id="ds-total">0</div><div class="sl">ç¸½æ–‡ç« æ•¸</div></div>
    <div class="stat-card"><div class="sn" id="ds-pub">0</div><div class="sl">å·²ç™¼å¸ƒ</div></div>
    <div class="stat-card"><div class="sn" id="ds-draft">0</div><div class="sl">è‰ç¨¿</div></div>
    <div class="stat-card"><div class="sn" id="ds-cats">5</div><div class="sl">åˆ†é¡æ•¸</div></div>
  </div>
  <div class="divider"></div>
  <div style="margin-bottom:16px;font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;">å¿«é€Ÿæ“ä½œ</div>
  <div class="qa-grid">
    <div class="qa" onclick="nav('editor')"><div class="qa-icon">âœï¸</div><div class="qa-label">æ–°å¢æ–‡ç« </div></div>
    <div class="qa" onclick="nav('posts')"><div class="qa-icon">ğŸ“‹</div><div class="qa-label">ç®¡ç†æ–‡ç« </div></div>
    <div class="qa" onclick="nav('homepage')"><div class="qa-icon">ğŸ </div><div class="qa-label">ç·¨è¼¯é¦–é </div></div>
  </div>
  <div class="divider"></div>
  <div style="margin-bottom:14px;font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;">æœ€è¿‘æ–‡ç« </div>
  <div id="ds-recent"></div>
</div>

<!-- POSTS -->
<div class="panel" id="p-posts">
  <div class="panel-title">æ–‡ç« ç®¡ç†</div>
  <div class="panel-sub">// POSTS â€” é»æ“Šã€Œç·¨è¼¯ã€ä¿®æ”¹æ–‡ç« å…§å®¹</div>
  <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
    <input type="text" id="search-posts" placeholder="æœå°‹æ–‡ç« æ¨™é¡Œ..." style="flex:1;min-width:180px;" oninput="renderPostList()">
    <select id="filter-cat" style="width:120px;" onchange="renderPostList()">
      <option value="">å…¨éƒ¨åˆ†é¡</option>
      <option>AI</option><option>é›²ç«¯</option><option>è³‡å®‰</option><option>é–±è®€</option><option>æˆé•·</option>
    </select>
    <select id="filter-status" style="width:100px;" onchange="renderPostList()">
      <option value="">å…¨éƒ¨ç‹€æ…‹</option>
      <option value="published">å·²ç™¼å¸ƒ</option>
      <option value="draft">è‰ç¨¿</option>
    </select>
  </div>
  <div class="post-list" id="post-list"></div>
</div>

<!-- EDITOR -->
<div class="panel" id="p-editor">
  <div class="panel-title" id="ed-title-label">æ–°å¢æ–‡ç« </div>
  <div class="panel-sub">// EDITOR â€” æ”¯æ´æ’å…¥é€£çµèˆ‡åœ–ç‰‡</div>

  <input type="hidden" id="ed-id" value="">

  <div class="form-group">
    <div class="form-label">æ–‡ç« æ¨™é¡Œ *</div>
    <input type="text" id="ed-ttl" placeholder="è¼¸å…¥æ–‡ç« æ¨™é¡Œ...">
  </div>

  <div class="form-row">
    <div class="form-group">
      <div class="form-label">åˆ†é¡</div>
      <select id="ed-cat">
        <option>AI</option><option>é›²ç«¯</option><option>è³‡å®‰</option><option>é–±è®€</option><option>æˆé•·</option>
      </select>
    </div>
    <div class="form-group">
      <div class="form-label">æ—¥æœŸ</div>
      <input type="date" id="ed-date">
    </div>
  </div>

  <div class="form-group">
    <div class="form-label">ç‹€æ…‹</div>
    <select id="ed-status">
      <option value="published">å·²ç™¼å¸ƒ</option>
      <option value="draft">è‰ç¨¿</option>
    </select>
  </div>

  <div class="form-group">
    <div class="form-label">æ‘˜è¦ <span class="tip">é¡¯ç¤ºåœ¨æ–‡ç« åˆ—è¡¨å¡ç‰‡ä¸Š</span></div>
    <textarea id="ed-exc" rows="3" placeholder="ç°¡çŸ­æè¿°é€™ç¯‡æ–‡ç« çš„é‡é»..."></textarea>
  </div>

  <!-- COVER IMAGE -->
  <div class="form-group">
    <div class="form-label">å°é¢åœ–ç‰‡ <span class="tip">é¡¯ç¤ºåœ¨æ–‡ç« å¡ç‰‡å’Œå…§é é ‚éƒ¨</span></div>
    <div class="img-drop" id="cover-drop" ondragover="dragOver(event,'cover-drop')" ondragleave="dragLeave('cover-drop')" ondrop="dropFile(event,'cover')">
      <input type="file" accept="image/*" onchange="handleImgFile(event,'cover')">
      <div class="img-drop-txt">ğŸ–¼ <span>é»æ“Šé¸æ“‡</span>æˆ–æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•</div>
    </div>
    <div class="img-url-or">æˆ–è¼¸å…¥åœ–ç‰‡ç¶²å€</div>
    <input type="url" id="ed-cover-url" placeholder="https://example.com/image.jpg" oninput="updateCoverPreview(this.value)">
    <div class="img-preview-wrap" id="cover-preview-wrap">
      <img class="img-preview" id="cover-preview" src="" alt="å°é¢é è¦½">
      <button class="btn btn-ghost" style="margin-top:8px;font-size:.6rem;padding:5px 12px;" onclick="clearCover()">âœ• ç§»é™¤å°é¢</button>
    </div>
  </div>

  <!-- RICH EDITOR -->
  <div class="form-group">
    <div class="form-label">æ–‡ç« å…§å®¹</div>
    <div class="editor-tabs">
      <button class="etab on" onclick="switchEditorTab('visual',this)">å¯è¦–åŒ–ç·¨è¼¯</button>
      <button class="etab" onclick="switchEditorTab('html',this)">HTML åŸå§‹ç¢¼</button>
    </div>
    <div class="editor-toolbar" id="etoolbar">
      <!-- æ–‡å­—æ ¼å¼ -->
      <select class="tb-select" onchange="formatBlock(this.value);this.value=''">
        <option value="">æ®µè½æ ¼å¼</option>
        <option value="h2">H2 æ¨™é¡Œ</option>
        <option value="h3">H3 å°æ¨™</option>
        <option value="p">æ®µè½</option>
        <option value="blockquote">å¼•è¨€</option>
        <option value="pre">ç¨‹å¼ç¢¼</option>
      </select>
      <div class="tb-sep"></div>
      <button class="tb-btn" onclick="fmt('bold')" title="ç²—é«”"><b>B</b></button>
      <button class="tb-btn" onclick="fmt('italic')" title="æ–œé«”"><i>I</i></button>
      <button class="tb-btn" onclick="fmt('underline')" title="åº•ç·š"><u>U</u></button>
      <button class="tb-btn" onclick="fmt('strikeThrough')" title="åˆªé™¤ç·š"><s>S</s></button>
      <div class="tb-sep"></div>
      <!-- é€£çµ -->
      <button class="tb-btn" onclick="openLinkModal()" title="æ’å…¥é€£çµ">ğŸ”— é€£çµ</button>
      <button class="tb-btn" onclick="removeLink()" title="ç§»é™¤é€£çµ">âœ‚ ç§»é™¤é€£çµ</button>
      <div class="tb-sep"></div>
      <!-- åœ–ç‰‡ -->
      <button class="tb-btn" onclick="openImgModal()" title="æ’å…¥åœ–ç‰‡">ğŸ–¼ åœ–ç‰‡</button>
      <div class="tb-sep"></div>
      <!-- æ¸…å–® -->
      <button class="tb-btn" onclick="fmt('insertUnorderedList')" title="ç„¡åºæ¸…å–®">â€¢ æ¸…å–®</button>
      <button class="tb-btn" onclick="fmt('insertOrderedList')" title="æœ‰åºæ¸…å–®">1. æ¸…å–®</button>
      <div class="tb-sep"></div>
      <!-- å°é½Š -->
      <button class="tb-btn" onclick="fmt('justifyLeft')" title="é å·¦">â¬…</button>
      <button class="tb-btn" onclick="fmt('justifyCenter')" title="ç½®ä¸­">â†”</button>
      <button class="tb-btn" onclick="fmt('justifyRight')" title="é å³">â¡</button>
      <div class="tb-sep"></div>
      <!-- å…¶ä»– -->
      <button class="tb-btn" onclick="insertHR()" title="åˆ†éš”ç·š">â€” åˆ†éš”ç·š</button>
      <button class="tb-btn" onclick="fmt('removeFormat')" title="æ¸…é™¤æ ¼å¼">âœ• æ¸…æ ¼å¼</button>
    </div>
    <div class="editor-area" id="ed-body" contenteditable="true" spellcheck="false"></div>
    <textarea class="html-area" id="ed-html" spellcheck="false" oninput="syncHTMLToVisual()"></textarea>
    <div class="editor-hint">æç¤ºï¼šç›´æ¥åœ¨ä¸Šæ–¹ç·¨è¼¯æ–‡å­—ï¼Œé¸å–æ–‡å­—å¾Œå¯å¥—ç”¨æ ¼å¼ã€‚Ctrl+Z å¯å¾©åŸã€‚</div>
  </div>

  <div class="btn-row">
    <button class="btn btn-primary" onclick="savePost()">ğŸ’¾ å„²å­˜æ–‡ç« </button>
    <button class="btn btn-ghost" onclick="previewPost()">ğŸ‘ é è¦½</button>
    <button class="btn btn-ghost" onclick="newPost()">+ æ–°æ–‡ç« </button>
    <button class="btn btn-danger" id="del-btn" style="display:none;" onclick="deleteCurrentPost()">ğŸ—‘ åˆªé™¤</button>
  </div>
</div>

<!-- HOMEPAGE -->
<div class="panel" id="p-homepage">
  <div class="panel-title">é¦–é è¨­å®š</div>
  <div class="panel-sub">// HOMEPAGE â€” ç·¨è¼¯é¦–é é¡¯ç¤ºå…§å®¹</div>
  <div class="form-row">
    <div class="form-group"><div class="form-label">æ¨™é¡Œç¬¬ä¸€æ®µ</div><input type="text" id="hp-t1" placeholder="æ“ä½œ"></div>
    <div class="form-group"><div class="form-label">æ¨™é¡Œç¬¬äºŒæ®µï¼ˆéœ“è™¹è‰²ï¼‰</div><input type="text" id="hp-t2" placeholder="ä¸€ä¸‹"></div>
  </div>
  <div class="form-group"><div class="form-label">èº«ä»½æ¨™ç±¤</div><input type="text" id="hp-tag" placeholder="å€‹äººå“ç‰Œ Â· è‡ªåª’é«”å‰µä½œè€…"></div>
  <div class="form-group"><div class="form-label">å‰¯æ¨™</div><input type="text" id="hp-sub" placeholder="operation.tw // é›²ç«¯ Â· è³‡å®‰ Â· AI Â· é–±è®€ Â· æˆé•·"></div>
  <div class="form-group"><div class="form-label">å¼•è¨€ <span class="tip">ï¼ˆæ›è¡Œç”¨ \nï¼‰</span></div><textarea id="hp-quote" rows="3" placeholder="ç°¡å–®çš„äº‹æƒ…å°ˆæ³¨åšï¼Œ\næœ‰ä¸€å¤©ä¸–ç•Œæœƒç‚ºäº†ä½ è€Œæ„Ÿå‹•"></textarea></div>
  <div class="form-group"><div class="form-label">CTA æŒ‰éˆ•æ–‡å­—</div><input type="text" id="hp-cta" placeholder="é–‹å§‹é–±è®€ â†’"></div>
  <div class="divider"></div>
  <div style="font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:14px;">é›»å­å ±å€å¡Š</div>
  <div class="form-group"><div class="form-label">æ¨™é¡Œ</div><input type="text" id="hp-nlt" placeholder="è¨‚é–±é›»å­å ±"></div>
  <div class="form-group"><div class="form-label">æè¿°</div><textarea id="hp-nld" rows="2" placeholder="æ¯é€±ç²¾é¸ä¸€ç¯‡æ·±åº¦æ–‡ç« ..."></textarea></div>
  <div class="divider"></div>
  <div style="font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:14px;">é å°¾</div>
  <div class="form-group"><div class="form-label">é å°¾ç‰ˆæ¬Šæ–‡å­—</div><input type="text" id="hp-footer" placeholder="Â© 2025 æ“ä½œä¸€ä¸‹"></div>
  <div class="btn-row"><button class="btn btn-primary" onclick="saveHomepage()">ğŸ’¾ å„²å­˜é¦–é è¨­å®š</button></div>
</div>

<!-- ABOUT -->
<div class="panel" id="p-about">
  <div class="panel-title">é—œæ–¼æˆ‘</div>
  <div class="panel-sub">// ABOUT â€” ç·¨è¼¯å€‹äººä»‹ç´¹å€å¡Š</div>
  <div class="form-group"><div class="form-label">é ­åƒç¸®å¯«ï¼ˆé¡¯ç¤ºåœ¨åœ“åœˆä¸­ï¼‰</div><input type="text" id="ab-init" placeholder="OP" maxlength="4"></div>
  <div class="form-group"><div class="form-label">å€‹äººç°¡ä»‹ <span class="tip">ï¼ˆæŒ‰ Enter æ›è¡Œï¼‰</span></div><textarea id="ab-bio" rows="6" placeholder="æˆ‘æ˜¯..."></textarea></div>
  <div class="form-row3">
    <div class="form-group"><div class="form-label">æ•¸å­— 1</div><input type="text" id="ab-s1n" placeholder="50+"></div>
    <div class="form-group"><div class="form-label">èªªæ˜ 1</div><input type="text" id="ab-s1l" placeholder="ç¯‡æ–‡ç« "></div>
  </div>
  <div class="form-row3">
    <div class="form-group"><div class="form-label">æ•¸å­— 2</div><input type="text" id="ab-s2n" placeholder="5"></div>
    <div class="form-group"><div class="form-label">èªªæ˜ 2</div><input type="text" id="ab-s2l" placeholder="æ ¸å¿ƒä¸»é¡Œ"></div>
  </div>
  <div class="form-row3">
    <div class="form-group"><div class="form-label">æ•¸å­— 3</div><input type="text" id="ab-s3n" placeholder="âˆ"></div>
    <div class="form-group"><div class="form-label">èªªæ˜ 3</div><input type="text" id="ab-s3l" placeholder="æŒçºŒæ›´æ–°"></div>
  </div>
  <div class="btn-row"><button class="btn btn-primary" onclick="saveAbout()">ğŸ’¾ å„²å­˜é—œæ–¼æˆ‘</button></div>
</div>

<!-- DATA -->
<div class="panel" id="p-data">
  <div class="panel-title">è³‡æ–™ç®¡ç†</div>
  <div class="panel-sub">// DATA â€” å‚™ä»½èˆ‡é‚„åŸæ‰€æœ‰è³‡æ–™</div>
  <div style="background:var(--bg2);border:1px solid var(--border);padding:20px;margin-bottom:16px;">
    <div style="font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--mid);margin-bottom:14px;">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</div>
    <p style="font-size:.85rem;color:var(--dim);margin-bottom:14px;">å°‡æ‰€æœ‰æ–‡ç« å’Œè¨­å®šä¸‹è¼‰ç‚º JSON å‚™ä»½æª”æ¡ˆã€‚</p>
    <button class="btn btn-primary" onclick="exportData()">â¬‡ ä¸‹è¼‰å‚™ä»½ JSON</button>
  </div>
  <div style="background:var(--bg2);border:1px solid var(--border);padding:20px;margin-bottom:16px;">
    <div style="font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--mid);margin-bottom:14px;">ğŸ“¥ åŒ¯å…¥é‚„åŸ</div>
    <p style="font-size:.85rem;color:var(--dim);margin-bottom:14px;">å¾å‚™ä»½ JSON æª”æ¡ˆé‚„åŸè³‡æ–™ï¼ˆæœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰ã€‚</p>
    <div class="img-drop" style="padding:16px;">
      <input type="file" accept=".json" onchange="importData(event)">
      <div class="img-drop-txt">é»æ“Šé¸æ“‡ JSON å‚™ä»½æª”æ¡ˆ</div>
    </div>
  </div>
  <div style="background:rgba(255,0,128,.04);border:1px solid rgba(255,0,128,.2);padding:20px;">
    <div style="font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--pink);margin-bottom:14px;">âš ï¸ å±éšªæ“ä½œ</div>
    <p style="font-size:.85rem;color:var(--dim);margin-bottom:14px;">æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œæ¢å¾©åˆ°é è¨­ç¯„ä¾‹å…§å®¹ã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
    <button class="btn btn-danger" onclick="resetData()">é‡è¨­ç‚ºé è¨­å€¼</button>
  </div>
</div>

</main>

<!-- LINK MODAL -->
<div class="modal-bg" id="link-modal">
  <div class="modal lm">
    <h3>ğŸ”— æ’å…¥é€£çµ</h3>
    <div class="form-group"><div class="form-label">é€£çµæ–‡å­—</div><input type="text" id="lm-text" placeholder="é¡¯ç¤ºæ–‡å­—"></div>
    <div class="form-group"><div class="form-label">é€£çµç¶²å€</div><input type="url" id="lm-url" placeholder="https://..."></div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:8px;font-family:'Share Tech Mono',monospace;font-size:.68rem;color:var(--mid);cursor:pointer;">
        <input type="checkbox" id="lm-new" checked> åœ¨æ–°åˆ†é é–‹å•Ÿ
      </label>
    </div>
    <div class="modal-btns">
      <button class="btn btn-primary" onclick="insertLink()">æ’å…¥é€£çµ</button>
      <button class="btn btn-ghost" onclick="closeModal('link-modal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- IMAGE MODAL -->
<div class="modal-bg" id="img-modal">
  <div class="modal" style="max-width:480px;">
    <h3>ğŸ–¼ æ’å…¥åœ–ç‰‡</h3>
    <div class="form-group">
      <div class="form-label">ä¸Šå‚³åœ–ç‰‡</div>
      <div class="img-drop" id="modal-img-drop" ondragover="dragOver(event,'modal-img-drop')" ondragleave="dragLeave('modal-img-drop')" ondrop="dropFile(event,'modal-img')">
        <input type="file" accept="image/*" onchange="handleImgFile(event,'modal-img')">
        <div class="img-drop-txt">ğŸ–¼ <span>é»æ“Šé¸æ“‡</span>æˆ–æ‹–æ›³åœ–ç‰‡</div>
      </div>
      <div class="img-url-or">æˆ–è¼¸å…¥åœ–ç‰‡ç¶²å€</div>
      <input type="url" id="mi-url" placeholder="https://example.com/image.jpg">
    </div>
    <div class="form-group">
      <div class="form-label">æ›¿ä»£æ–‡å­—ï¼ˆaltï¼‰</div>
      <input type="text" id="mi-alt" placeholder="åœ–ç‰‡èªªæ˜">
    </div>
    <div class="img-preview-wrap" id="mi-preview-wrap">
      <img class="img-preview" id="mi-preview" src="" alt="">
    </div>
    <div class="modal-btns" style="margin-top:20px;">
      <button class="btn btn-primary" onclick="insertImg()">æ’å…¥åœ–ç‰‡</button>
      <button class="btn btn-ghost" onclick="closeModal('img-modal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM -->
<div class="modal-bg" id="del-modal">
  <div class="modal">
    <h3>åˆªé™¤æ–‡ç« </h3>
    <p>ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
    <div class="modal-btns">
      <button class="btn btn-danger" onclick="confirmDelete()">ç¢ºå®šåˆªé™¤</button>
      <button class="btn btn-ghost" onclick="closeModal('del-modal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ SUPABASE â”€â”€
const SUPABASE_URL='https://pvqvnmntqhsfzarbxayf.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2cXZubW50cWhzZnphcmJ4YXlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjQ0MjUsImV4cCI6MjA4NzI0MDQyNX0.sKn8yzJos9F8ghKrp3icx6zR2RO39898DenWlLodpqA';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const CAT_COLOR={AI:'#bf00ff',é›²ç«¯:'#00f5ff',è³‡å®‰:'#ff0080',é–±è®€:'#ffff00',æˆé•·:'#00ff88'};

const DEFAULTS={
  posts:[
    {title:'å¾ GPT åˆ° Claudeï¼š2025 å¹´ AI å·¥å…·é¸æ“‡æŒ‡å—',category:'AI',date:'2025-02-15',status:'published',
     excerpt:'æ·±å…¥æ¯”è¼ƒä¸»æµ AI åŠ©ç†çš„ä½¿ç”¨å ´æ™¯ï¼Œæ‰¾åˆ°æœ€é©åˆä½ å·¥ä½œæµç¨‹çš„é‚£ä¸€å€‹ã€‚',image:'',
     body:'<p>2025 å¹´ï¼ŒAI åŠ©ç†å·²ç¶“ä¸å†æ˜¯æ–°å¥‡ç©å…·ï¼Œè€Œæ˜¯çœŸå¯¦å½±éŸ¿å·¥ä½œæ•ˆç‡çš„æ ¸å¿ƒå·¥å…·ã€‚</p><h2>GPT-4o çš„å¼·é …</h2><p>OpenAI çš„ GPT-4o åœ¨å¤šæ¨¡æ…‹è™•ç†ä¸Šè¡¨ç¾å‡ºè‰²ï¼Œç‰¹åˆ¥æ˜¯åœ–ç‰‡ç†è§£å’ŒèªéŸ³è¼¸å…¥ã€‚</p><h2>Claude çš„å¼·é …</h2><p>Anthropic çš„ Claude åœ¨é•·æ–‡è™•ç†å’Œé‚è¼¯æ¨ç†ä¸Šæœ‰å„ªå‹¢ï¼Œç‰¹åˆ¥é©åˆè™•ç†å¤§é‡æ–‡ä»¶ã€ç¨‹å¼ç¢¼å¯©æŸ¥å’Œè¤‡é›œåˆ†æä»»å‹™ã€‚</p><h2>æˆ‘çš„å»ºè­°</h2><p>æ²’æœ‰ã€Œæœ€å¥½ã€çš„ AI å·¥å…·ï¼Œåªæœ‰æœ€é©åˆä½ å·¥ä½œæµç¨‹çš„é‚£ä¸€å€‹ã€‚å¯ä»¥åƒè€ƒ <a href="https://openai.com" target="_blank">OpenAI å®˜ç¶²</a> äº†è§£æœ€æ–°åŠŸèƒ½ã€‚</p>'},
    {title:'AWS vs Azure vs GCPï¼šé¸æ“‡é›²ç«¯å¹³å°çš„ä¸‰å€‹é—œéµå•é¡Œ',category:'é›²ç«¯',date:'2025-02-08',status:'published',
     excerpt:'ä¸ç”¨èƒŒæ‰€æœ‰æœå‹™åç¨±ï¼Œåªè¦å•å°å•é¡Œï¼Œä½ å°±çŸ¥é“å“ªå€‹é›²æ›´é©åˆä½ çš„éœ€æ±‚ã€‚',image:'',
     body:'<p>é›²ç«¯å¹³å°çš„é¸æ“‡å›°æ“¾è‘—å¾ˆå¤šäººï¼Œä½†å…¶å¯¦åªéœ€è¦å•è‡ªå·±ä¸‰å€‹å•é¡Œã€‚</p><h2>å•é¡Œä¸€ï¼šä½ çš„åœ˜éšŠç”¨ä»€éº¼æŠ€è¡“æ£§ï¼Ÿ</h2><p>å¦‚æœä¸»è¦ä½¿ç”¨å¾®è»ŸæŠ€è¡“ï¼ŒAzure çš„æ•´åˆå„ªå‹¢æ˜é¡¯ã€‚</p><h2>å•é¡ŒäºŒï¼šä½ çš„ä¸»è¦å¸‚å ´åœ¨å“ªè£¡ï¼Ÿ</h2><p>AWS åœ¨å…¨çƒè¦†è“‹ç‡æœ€é«˜ï¼Œé©åˆå…¨çƒéƒ¨ç½²ã€‚</p><h2>å•é¡Œä¸‰ï¼šä½ çš„é ç®—æ¨¡å¼ï¼Ÿ</h2><p>GCP æä¾›æŒçºŒä½¿ç”¨æŠ˜æ‰£ï¼›Azure å°ä¼æ¥­æˆæ¬Šç”¨æˆ¶æœ‰å„ªæƒ ã€‚</p>'},
    {title:'é›¶ä¿¡ä»»æ¶æ§‹å…¥é–€ï¼šç‚ºä»€éº¼ã€Œç›¸ä¿¡ä½†é©—è­‰ã€å·²ç¶“éæ™‚äº†',category:'è³‡å®‰',date:'2025-01-29',status:'published',
     excerpt:'ç¾ä»£è³‡å®‰æ€ç¶­çš„è½‰è®Šï¼Œä»¥åŠä¼æ¥­å¦‚ä½•åœ¨æ··åˆå·¥ä½œæ™‚ä»£ä¿è­·æ•¸ä½é‚Šç•Œã€‚',image:'',
     body:'<p>é›¶ä¿¡ä»»çš„æ ¸å¿ƒæ˜¯ã€Œæ°¸ä¸ä¿¡ä»»ï¼Œå§‹çµ‚é©—è­‰ã€ã€‚</p><h2>ç‚ºä»€éº¼éœ€è¦é›¶ä¿¡ä»»ï¼Ÿ</h2><p>æ··åˆå·¥ä½œæ¨¡å¼è®“å‚³çµ± VPN å·²ç„¡æ³•æ‡‰å°åˆ†æ•£å¼å·¥ä½œç’°å¢ƒã€‚</p><h2>å¦‚ä½•é–‹å§‹ï¼Ÿ</h2><ul><li><strong>å¤šå› ç´ é©—è­‰</strong>ï¼šæœ€ä½æˆæœ¬ã€æœ€é«˜å›å ±çš„ç¬¬ä¸€æ­¥</li><li><strong>æœ€å°æ¬Šé™</strong>ï¼šåªçµ¦å®Œæˆä»»å‹™æ‰€éœ€çš„æœ€ä½å­˜å–æ¬Šé™</li></ul>'},
  ],
  hp:{tag:'å€‹äººå“ç‰Œ Â· è‡ªåª’é«”å‰µä½œè€…',t1:'æ“ä½œ',t2:'ä¸€ä¸‹',sub:'operation.tw // é›²ç«¯ Â· è³‡å®‰ Â· AI Â· é–±è®€ Â· æˆé•·',quote:'ç°¡å–®çš„äº‹æƒ…å°ˆæ³¨åšï¼Œ\næœ‰ä¸€å¤©ä¸–ç•Œæœƒç‚ºäº†ä½ è€Œæ„Ÿå‹•',cta:'é–‹å§‹é–±è®€ â†’',nlt:'è¨‚é–±é›»å­å ±',nld:'æ¯é€±ç²¾é¸ä¸€ç¯‡æ·±åº¦æ–‡ç« ï¼Œç›´æ¥é€åˆ°ä½ çš„ä¿¡ç®±ã€‚ä¸ç™¼å»£å‘Šï¼Œåªçµ¦å€¼å¾—è®€çš„å…§å®¹ã€‚'},
  about:{initials:'OP',bio:'æˆ‘æ˜¯æ“ä½œä¸€ä¸‹ï¼Œæ·±è€•é›²ç«¯ã€è³‡å®‰èˆ‡ AI çš„è‡ªåª’é«”å‰µä½œè€…ã€‚\n\næˆ‘ç›¸ä¿¡ç§‘æŠ€ä¸æ‡‰åªæ˜¯å·¥ç¨‹å¸«çš„èªè¨€ï¼Œæ¯å€‹äººéƒ½å€¼å¾—ç†è§£é€™äº›å·¥å…·ã€‚\n\nä¸è³£èª²ç¨‹ï¼Œä¸è¿½æµé‡ï¼Œåªæƒ³æŠŠæœ‰ç”¨çš„æ±è¥¿èªªæ¸…æ¥šã€‚',s1n:'50+',s1l:'ç¯‡æ–‡ç« ',s2n:'5',s2l:'æ ¸å¿ƒä¸»é¡Œ',s3n:'âˆ',s3l:'æŒçºŒæ›´æ–°'},
  footer:'Â© 2025 æ“ä½œä¸€ä¸‹ Â· ç°¡å–®çš„äº‹æƒ…å°ˆæ³¨åš'
};

let D={posts:[],hp:DEFAULTS.hp,about:DEFAULTS.about,footer:DEFAULTS.footer};

// â”€â”€ DB INIT â”€â”€
async function initDB(){
  try{
    const [pr,sr]=await Promise.all([
      sb.from('posts').select('*').order('date',{ascending:false}),
      sb.from('settings').select('*')
    ]);
    if(pr.error)throw pr.error;
    const sm={};
    (sr.data||[]).forEach(s=>{sm[s.key]=s.value;});
    D={
      posts:pr.data||[],
      hp:sm.hp||DEFAULTS.hp,
      about:sm.about||DEFAULTS.about,
      footer:(sm.footer&&sm.footer.text)||DEFAULTS.footer
    };
    if(!pr.data.length&&!Object.keys(sm).length){await seedDefaults();return;}
  }catch(err){
    console.error('Supabase error:',err);
    toast('è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèª Supabase è¨­å®š','error');
  }
  renderDash();
}

async function seedDefaults(){
  const rows=DEFAULTS.posts.map(({id,...r})=>r);
  await sb.from('posts').insert(rows);
  await Promise.all([
    sb.from('settings').upsert({key:'hp',value:DEFAULTS.hp}),
    sb.from('settings').upsert({key:'about',value:DEFAULTS.about}),
    sb.from('settings').upsert({key:'footer',value:{text:DEFAULTS.footer}})
  ]);
  await initDB();
}

// â”€â”€ NAV â”€â”€
function nav(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(b=>b.classList.remove('active'));
  document.getElementById('p-'+id).classList.add('active');
  const nb=document.getElementById('nav-'+id);if(nb)nb.classList.add('active');
  if(id==='dashboard')renderDash();
  if(id==='posts')renderPostList();
  if(id==='editor'&&!document.getElementById('ed-id').value)newPost();
  if(id==='homepage')loadHomepage();
  if(id==='about')loadAbout();
}

// â”€â”€ DASHBOARD â”€â”€
function renderDash(){
  const pub=D.posts.filter(p=>p.status==='published').length;
  const dft=D.posts.filter(p=>p.status==='draft').length;
  setText('ds-total',D.posts.length);setText('ds-pub',pub);setText('ds-draft',dft);
  const recent=[...D.posts].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  const el=document.getElementById('ds-recent');
  el.innerHTML=recent.map(p=>{
    const c=CAT_COLOR[p.category]||'#aaa';
    return '<div class="post-row"><span class="pr-cat" style="border-color:'+c+';color:'+c+';">'+p.category+'</span><span class="pr-title">'+esc(p.title)+'</span><span class="pr-date">'+p.date+'</span><span class="pr-status '+(p.status==='published'?'pub':'dft')+'">'+(p.status==='published'?'å·²ç™¼å¸ƒ':'è‰ç¨¿')+'</span><div class="pr-actions"><button class="pr-btn" onclick="editPost('+p.id+')">ç·¨è¼¯</button></div></div>';
  }).join('');
}

// â”€â”€ POST LIST â”€â”€
function renderPostList(){
  const q=(document.getElementById('search-posts').value||'').toLowerCase();
  const cat=document.getElementById('filter-cat').value;
  const status=document.getElementById('filter-status').value;
  const filtered=D.posts.filter(p=>(!q||p.title.toLowerCase().includes(q))&&(!cat||p.category===cat)&&(!status||p.status===status)).sort((a,b)=>new Date(b.date)-new Date(a.date));
  const el=document.getElementById('post-list');
  if(!filtered.length){el.innerHTML='<div style="padding:28px;text-align:center;font-family:\'Share Tech Mono\',monospace;font-size:.72rem;color:var(--dim);">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ–‡ç« </div>';return;}
  el.innerHTML=filtered.map(p=>{
    const c=CAT_COLOR[p.category]||'#aaa';
    return '<div class="post-row"><span class="pr-cat" style="border-color:'+c+';color:'+c+';">'+p.category+'</span><span class="pr-title">'+esc(p.title)+'</span><span class="pr-date">'+p.date+'</span><span class="pr-status '+(p.status==='published'?'pub':'dft')+'">'+(p.status==='published'?'å·²ç™¼å¸ƒ':'è‰ç¨¿')+'</span><div class="pr-actions"><button class="pr-btn" onclick="editPost('+p.id+')">ç·¨è¼¯</button><button class="pr-btn del" onclick="askDelete('+p.id+')">åˆªé™¤</button></div></div>';
  }).join('');
}

// â”€â”€ EDITOR â”€â”€
function newPost(){
  document.getElementById('ed-id').value='';
  document.getElementById('ed-ttl').value='';
  document.getElementById('ed-cat').value='AI';
  document.getElementById('ed-date').value=new Date().toISOString().slice(0,10);
  document.getElementById('ed-status').value='draft';
  document.getElementById('ed-exc').value='';
  document.getElementById('ed-cover-url').value='';
  document.getElementById('ed-body').innerHTML='';
  document.getElementById('ed-html').value='';
  document.getElementById('cover-preview-wrap').style.display='none';
  document.getElementById('ed-title-label').textContent='æ–°å¢æ–‡ç« ';
  document.getElementById('del-btn').style.display='none';
  nav('editor');
}

function editPost(id){
  const p=D.posts.find(x=>x.id==id);if(!p)return;
  document.getElementById('ed-id').value=id;
  document.getElementById('ed-ttl').value=p.title;
  document.getElementById('ed-cat').value=p.category;
  document.getElementById('ed-date').value=p.date;
  document.getElementById('ed-status').value=p.status;
  document.getElementById('ed-exc').value=p.excerpt||'';
  document.getElementById('ed-cover-url').value=p.image||'';
  document.getElementById('ed-body').innerHTML=p.body||'';
  document.getElementById('ed-html').value=p.body||'';
  if(p.image){document.getElementById('cover-preview').src=p.image;document.getElementById('cover-preview-wrap').style.display='block';}
  else document.getElementById('cover-preview-wrap').style.display='none';
  document.getElementById('ed-title-label').textContent='ç·¨è¼¯æ–‡ç« ';
  document.getElementById('del-btn').style.display='inline-flex';
  nav('editor');
}

async function savePost(){
  const id=document.getElementById('ed-id').value;
  const title=document.getElementById('ed-ttl').value.trim();
  if(!title){toast('è«‹è¼¸å…¥æ–‡ç« æ¨™é¡Œï¼','error');return;}
  const body=getCurrentBody();
  const post={title,category:document.getElementById('ed-cat').value,date:document.getElementById('ed-date').value,status:document.getElementById('ed-status').value,excerpt:document.getElementById('ed-exc').value.trim(),image:document.getElementById('ed-cover-url').value.trim(),body};
  if(id){
    const {error}=await sb.from('posts').update(post).eq('id',id);
    if(error){toast('å„²å­˜å¤±æ•—ï¼š'+error.message,'error');return;}
    const idx=D.posts.findIndex(x=>x.id==id);
    if(idx>=0)D.posts[idx]={...D.posts[idx],...post};
  }else{
    const {data,error}=await sb.from('posts').insert(post).select().single();
    if(error){toast('å„²å­˜å¤±æ•—ï¼š'+error.message,'error');return;}
    D.posts.unshift(data);
    document.getElementById('ed-id').value=data.id;
    document.getElementById('del-btn').style.display='inline-flex';
    document.getElementById('ed-title-label').textContent='ç·¨è¼¯æ–‡ç« ';
  }
  toast('æ–‡ç« å·²å„²å­˜ âœ“');
}

function getCurrentBody(){
  const activeTab=document.querySelector('.etab.on');
  if(activeTab&&activeTab.textContent.includes('HTML'))return document.getElementById('ed-html').value;
  return document.getElementById('ed-body').innerHTML;
}

function previewPost(){savePost();window.open('index.html','_blank');}

let deleteTargetId=null;
function askDelete(id){deleteTargetId=id;openModal('del-modal');}
function deleteCurrentPost(){deleteTargetId=parseInt(document.getElementById('ed-id').value);openModal('del-modal');}
async function confirmDelete(){
  if(!deleteTargetId)return;
  const {error}=await sb.from('posts').delete().eq('id',deleteTargetId);
  if(error){toast('åˆªé™¤å¤±æ•—ï¼š'+error.message,'error');return;}
  D.posts=D.posts.filter(x=>x.id!==deleteTargetId);
  closeModal('del-modal');toast('æ–‡ç« å·²åˆªé™¤');deleteTargetId=null;newPost();renderPostList();
}

// â”€â”€ EDITOR TABS â”€â”€
function switchEditorTab(mode,btn){
  document.querySelectorAll('.etab').forEach(t=>t.classList.remove('on'));btn.classList.add('on');
  const visual=document.getElementById('ed-body'),html=document.getElementById('ed-html'),toolbar=document.getElementById('etoolbar');
  if(mode==='visual'){html.style.display='none';visual.style.display='block';toolbar.style.display='flex';visual.innerHTML=html.value;}
  else{visual.style.display='none';html.style.display='block';toolbar.style.display='none';html.value=visual.innerHTML;}
}
function syncHTMLToVisual(){document.getElementById('ed-body').innerHTML=document.getElementById('ed-html').value;}

// â”€â”€ RICH TEXT â”€â”€
function fmt(cmd){document.getElementById('ed-body').focus();document.execCommand(cmd,false,null);}
function formatBlock(tag){if(!tag)return;document.getElementById('ed-body').focus();document.execCommand('formatBlock',false,tag);}
function insertHR(){document.getElementById('ed-body').focus();document.execCommand('insertHTML',false,'<hr>');}

// â”€â”€ LINK MODAL â”€â”€
let savedRange=null;
function saveRange(){const sel=window.getSelection();if(sel.rangeCount>0)savedRange=sel.getRangeAt(0).cloneRange();}
function restoreRange(){if(savedRange){const sel=window.getSelection();sel.removeAllRanges();sel.addRange(savedRange);}}
function openLinkModal(){
  const txt=window.getSelection().toString();saveRange();
  document.getElementById('lm-text').value=txt||'';document.getElementById('lm-url').value='https://';
  openModal('link-modal');setTimeout(()=>document.getElementById('lm-url').focus(),100);
}
function insertLink(){
  const url=document.getElementById('lm-url').value.trim(),text=document.getElementById('lm-text').value.trim(),newTab=document.getElementById('lm-new').checked;
  if(!url||url==='https://'){toast('è«‹è¼¸å…¥é€£çµç¶²å€','error');return;}
  closeModal('link-modal');document.getElementById('ed-body').focus();restoreRange();
  const target=newTab?' target="_blank" rel="noopener"':'';
  if(text){document.execCommand('insertHTML',false,'<a href="'+url+'"'+target+'>'+text+'</a>');}
  else{
    document.execCommand('createLink',false,url);
    if(newTab){const sel=window.getSelection();if(sel.anchorNode&&sel.anchorNode.parentElement&&sel.anchorNode.parentElement.tagName==='A'){sel.anchorNode.parentElement.setAttribute('target','_blank');sel.anchorNode.parentElement.setAttribute('rel','noopener');}}
  }
}
function removeLink(){document.getElementById('ed-body').focus();document.execCommand('unlink',false,null);}

// â”€â”€ IMAGE MODAL â”€â”€
let pendingImgSrc='';
function openImgModal(){
  saveRange();pendingImgSrc='';document.getElementById('mi-url').value='';document.getElementById('mi-alt').value='';
  document.getElementById('mi-preview').src='';document.getElementById('mi-preview-wrap').style.display='none';openModal('img-modal');
}
function insertImg(){
  const url=document.getElementById('mi-url').value.trim()||pendingImgSrc,alt=document.getElementById('mi-alt').value.trim();
  if(!url){toast('è«‹é¸æ“‡æˆ–è¼¸å…¥åœ–ç‰‡ç¶²å€','error');return;}
  closeModal('img-modal');document.getElementById('ed-body').focus();restoreRange();
  document.execCommand('insertHTML',false,'<img src="'+url+'" alt="'+alt+'" style="max-width:100%;margin:12px 0;display:block;">');
}

// â”€â”€ IMAGE UPLOAD â”€â”€
function handleImgFile(event,target){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const src=e.target.result;
    if(target==='cover'){document.getElementById('ed-cover-url').value=src;document.getElementById('cover-preview').src=src;document.getElementById('cover-preview-wrap').style.display='block';}
    else if(target==='modal-img'){pendingImgSrc=src;document.getElementById('mi-url').value='';document.getElementById('mi-preview').src=src;document.getElementById('mi-preview-wrap').style.display='block';}
  };reader.readAsDataURL(file);
}
function updateCoverPreview(url){if(url){document.getElementById('cover-preview').src=url;document.getElementById('cover-preview-wrap').style.display='block';}else document.getElementById('cover-preview-wrap').style.display='none';}
function clearCover(){document.getElementById('ed-cover-url').value='';document.getElementById('cover-preview-wrap').style.display='none';}
document.getElementById('mi-url').addEventListener('input',function(){if(this.value){document.getElementById('mi-preview').src=this.value;document.getElementById('mi-preview-wrap').style.display='block';pendingImgSrc='';}});

// â”€â”€ DRAG & DROP â”€â”€
function dragOver(e,id){e.preventDefault();document.getElementById(id).classList.add('drag');}
function dragLeave(id){document.getElementById(id).classList.remove('drag');}
function dropFile(e,target){
  e.preventDefault();const id=target==='cover'?'cover-drop':'modal-img-drop';dragLeave(id);
  const file=e.dataTransfer.files[0];if(!file||!file.type.startsWith('image/'))return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const src=ev.target.result;
    if(target==='cover'){document.getElementById('ed-cover-url').value=src;document.getElementById('cover-preview').src=src;document.getElementById('cover-preview-wrap').style.display='block';}
    else{pendingImgSrc=src;document.getElementById('mi-preview').src=src;document.getElementById('mi-preview-wrap').style.display='block';}
  };reader.readAsDataURL(file);
}

// â”€â”€ HOMEPAGE â”€â”€
function loadHomepage(){
  const h=D.hp||{};
  setVal('hp-t1',h.t1);setVal('hp-t2',h.t2);setVal('hp-tag',h.tag);setVal('hp-sub',h.sub);setVal('hp-quote',h.quote);setVal('hp-cta',h.cta);setVal('hp-nlt',h.nlt);setVal('hp-nld',h.nld);setVal('hp-footer',D.footer);
}
async function saveHomepage(){
  const hp={t1:getVal('hp-t1'),t2:getVal('hp-t2'),tag:getVal('hp-tag'),sub:getVal('hp-sub'),quote:getVal('hp-quote'),cta:getVal('hp-cta'),nlt:getVal('hp-nlt'),nld:getVal('hp-nld')};
  const footerText=getVal('hp-footer');
  const [r1,r2]=await Promise.all([sb.from('settings').upsert({key:'hp',value:hp}),sb.from('settings').upsert({key:'footer',value:{text:footerText}})]);
  if(r1.error||r2.error){toast('å„²å­˜å¤±æ•—','error');return;}
  D.hp=hp;D.footer=footerText;toast('é¦–é è¨­å®šå·²å„²å­˜ âœ“');
}

// â”€â”€ ABOUT â”€â”€
function loadAbout(){
  const a=D.about||{};
  setVal('ab-init',a.initials);setVal('ab-bio',a.bio);setVal('ab-s1n',a.s1n);setVal('ab-s1l',a.s1l);setVal('ab-s2n',a.s2n);setVal('ab-s2l',a.s2l);setVal('ab-s3n',a.s3n);setVal('ab-s3l',a.s3l);
}
async function saveAbout(){
  const about={initials:getVal('ab-init'),bio:getVal('ab-bio'),s1n:getVal('ab-s1n'),s1l:getVal('ab-s1l'),s2n:getVal('ab-s2n'),s2l:getVal('ab-s2l'),s3n:getVal('ab-s3n'),s3l:getVal('ab-s3l')};
  const {error}=await sb.from('settings').upsert({key:'about',value:about});
  if(error){toast('å„²å­˜å¤±æ•—ï¼š'+error.message,'error');return;}
  D.about=about;toast('é—œæ–¼æˆ‘å·²å„²å­˜ âœ“');
}

// â”€â”€ DATA â”€â”€
function exportData(){
  const blob=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='operation-tw-backup-'+new Date().toISOString().slice(0,10)+'.json';a.click();
}
async function importData(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const d=JSON.parse(e.target.result);
      await sb.from('posts').delete().gt('id',0);
      if(d.posts&&d.posts.length){const rows=d.posts.map(({id,created_at,...r})=>r);const {error}=await sb.from('posts').insert(rows);if(error)throw error;}
      const ups=[];
      if(d.hp)ups.push(sb.from('settings').upsert({key:'hp',value:d.hp}));
      if(d.about)ups.push(sb.from('settings').upsert({key:'about',value:d.about}));
      if(d.footer)ups.push(sb.from('settings').upsert({key:'footer',value:{text:d.footer}}));
      await Promise.all(ups);await initDB();toast('è³‡æ–™å·²åŒ¯å…¥ âœ“');
    }catch(err){toast('åŒ¯å…¥å¤±æ•—ï¼š'+err.message,'error');}
  };reader.readAsText(file);
}
async function resetData(){
  if(!confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚'))return;
  await sb.from('posts').delete().gt('id',0);
  const rows=DEFAULTS.posts.map(({id,...r})=>r);
  await sb.from('posts').insert(rows);
  await sb.from('settings').upsert({key:'hp',value:DEFAULTS.hp});
  await sb.from('settings').upsert({key:'about',value:DEFAULTS.about});
  await sb.from('settings').upsert({key:'footer',value:{text:DEFAULTS.footer}});
  await initDB();toast('å·²é‡è¨­ç‚ºé è¨­å€¼');
}

// â”€â”€ MODAL â”€â”€
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-bg').forEach(m=>m.addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');}));

// â”€â”€ TOAST â”€â”€
let toastTimer;
function toast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast show'+(type?' '+type:'');
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2800);
}

// â”€â”€ UTILS â”€â”€
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function setText(id,v){const e=document.getElementById(id);if(e)e.textContent=v;}
function setVal(id,v){const e=document.getElementById(id);if(e&&v!=null)e.value=v;}
function getVal(id){const e=document.getElementById(id);return e?e.value:'';}

// â”€â”€ INIT â”€â”€
initDB();
</script>
</body>
</html>
